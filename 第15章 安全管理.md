# ç¬¬15ç«  å®‰å…¨ç®¡ç†

> HPCé›†ç¾¤å®‰å…¨åŠ å›ºä¸å®‰å…¨ç®¡ç†å®æˆ˜æŒ‡å—

## ğŸ›¡ï¸ æœ¬ç« æ¦‚è¿°

å®‰å…¨ç®¡ç†æ˜¯HPCè¿ç»´çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚æœ¬ç« å°†æ·±å…¥ä»‹ç»HPCé›†ç¾¤çš„å®‰å…¨åŠ å›ºæ–¹æ³•ã€è®¿é—®æ§åˆ¶ç­–ç•¥ã€å®‰å…¨å®¡è®¡ç›‘æ§å’Œæ¼æ´ç®¡ç†ï¼Œå¸®åŠ©ä½ å»ºç«‹å®Œå–„çš„å®‰å…¨é˜²æŠ¤ä½“ç³»ï¼Œä¿éšœé›†ç¾¤çš„å®‰å…¨ç¨³å®šè¿è¡Œã€‚

**å­¦ä¹ ç›®æ ‡ï¼š**
- æŒæ¡HPCé›†ç¾¤çš„ç³»ç»Ÿå®‰å…¨åŠ å›ºæŠ€æœ¯
- å­¦ä¼šé…ç½®æœ‰æ•ˆçš„è®¿é—®æ§åˆ¶ç­–ç•¥
- å»ºç«‹å®Œå–„çš„å®‰å…¨å®¡è®¡å’Œç›‘æ§ä½“ç³»
- å®æ–½ç³»ç»Ÿçš„æ¼æ´ç®¡ç†æµç¨‹

## ğŸ”’ å®‰å…¨ç®¡ç†æ¡†æ¶

### 15.1 ç³»ç»Ÿå®‰å…¨åŠ å›º

#### 15.1.1 æ“ä½œç³»ç»Ÿå®‰å…¨åŠ å›º

**åŸºç¡€ç³»ç»ŸåŠ å›ºè„šæœ¬ï¼š**

```bash
#!/bin/bash
# /opt/security/system_hardening.sh

echo "=== HPC Cluster System Hardening ==="
echo "Starting security hardening process..."

# 1. æ›´æ–°ç³»ç»Ÿå’Œå®‰å…¨è¡¥ä¸
echo "1. Updating system and security patches..."
yum update -y
yum install -y yum-security
yum update --security -y

# 2. ç¦ç”¨ä¸å¿…è¦çš„æœåŠ¡
echo "2. Disabling unnecessary services..."
SERVICES_TO_DISABLE=(
    "telnet"
    "rsh"
    "rlogin"
    "ftp"
    "tftp"
    "finger"
    "chargen"
    "daytime"
    "echo"
    "discard"
)

for service in "${SERVICES_TO_DISABLE[@]}"; do
    if systemctl list-unit-files | grep -q "^$service"; then
        systemctl stop $service 2>/dev/null
        systemctl disable $service 2>/dev/null
        echo "  Disabled: $service"
    fi
done

# 3. é…ç½®é˜²ç«å¢™
echo "3. Configuring firewall..."
systemctl enable firewalld
systemctl start firewalld

# å…è®¸å¿…è¦çš„æœåŠ¡
firewall-cmd --permanent --add-service=ssh
firewall-cmd --permanent --add-port=80/tcp
firewall-cmd --permanent --add-port=443/tcp
firewall-cmd --permanent --add-port=68/udp  # DHCP
firewall-cmd --permanent --add-port=53/udp  # DNS

# å¦‚æœä½¿ç”¨SLURMï¼Œæ·»åŠ ç›¸å…³ç«¯å£
firewall-cmd --permanent --add-port=6817/tcp  # SLURM
firewall-cmd --permanent --add-port=6818/tcp  # SLURMDBD

# é‡æ–°åŠ è½½é˜²ç«å¢™é…ç½®
firewall-cmd --reload

# 4. é…ç½®SSHå®‰å…¨
echo "4. Configuring SSH security..."
cat > /etc/ssh/sshd_config << 'EOF'
# SSH Security Configuration
Port 22
Protocol 2
PermitRootLogin no
PermitEmptyPasswords no
PasswordAuthentication yes
PubkeyAuthentication yes
AuthorizedKeysFile      .ssh/authorized_keys
MaxAuthTries 3
MaxSessions 5
ClientAliveInterval 300
ClientAliveCountMax 0
X11Forwarding no
AllowUsers *@localhost *@127.0.0.1
DenyUsers root
DenyGroups root
LogLevel VERBOSE
EOF

systemctl restart sshd

# 5. é…ç½®ç³»ç»Ÿå†…æ ¸å‚æ•°
echo "5. Configuring kernel security parameters..."
cat > /etc/sysctl.d/99-security.conf << 'EOF'
# Security Kernel Parameters

# Disable IP forwarding
net.ipv4.ip_forward = 0

# Disable ICMP redirects
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv6.conf.all.accept_redirects = 0
net.ipv6.conf.default.accept_redirects = 0

# Disable source route packets
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.send_redirects = 0
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0
net.ipv6.conf.all.accept_source_route = 0
net.ipv6.conf.default.accept_source_route = 0

# Enable TCP SYN Cookie Protection
net.ipv4.tcp_syncookies = 1

# Disable broadcast ICMP
net.ipv4.icmp_echo_ignore_broadcasts = 1

# Log martian packets
net.ipv4.conf.all.log_martians = 1
net.ipv4.conf.default.log_martians = 1

# Enable IP spoofing protection
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.default.rp_filter = 1

# Don't accept or send ICMP redirects
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv4.conf.all.secure_redirects = 0
net.ipv4.conf.default.secure_redirects = 0
net.ipv6.conf.all.accept_redirects = 0
net.ipv6.conf.default.accept_redirects = 0

# Don't act as a router
net.ipv4.ip_forward = 0
net.ipv6.conf.all.forwarding = 0
EOF

sysctl -p /etc/sysctl.d/99-security.conf

# 6. é…ç½®æ–‡ä»¶æƒé™
echo "6. Setting secure file permissions..."
# è®¾ç½®å…³é”®ç³»ç»Ÿæ–‡ä»¶æƒé™
chmod 600 /etc/grub.conf
chmod 600 /boot/grub/grub.conf
chmod 600 /etc/shadow
chmod 644 /etc/passwd
chmod 644 /etc/group

# è®¾ç½®SSHå¯†é’¥æƒé™
chmod 700 ~/.ssh
chmod 600 ~/.ssh/authorized_keys

# 7. é…ç½®ç”¨æˆ·ç¯å¢ƒå®‰å…¨
echo "7. Configuring user environment security..."
# è®¾ç½®umask
echo "umask 027" >> /etc/bashrc
echo "umask 027" >> /etc/profile

# é…ç½®å¯†ç ç­–ç•¥
cat > /etc/security/pwquality.conf << 'EOF'
# Password Quality Configuration
minlen = 12
minclass = 3
maxrepeat = 2
dcredit = -1
ucredit = -1
lcredit = -1
ocredit = -1
EOF

# 8. å®‰è£…å’Œé…ç½®å®‰å…¨å·¥å…·
echo "8. Installing security tools..."
yum install -y fail2ban rkhunter chkrootkit

# é…ç½®fail2ban
cat > /etc/fail2ban/jail.local << 'EOF'
[DEFAULT]
bantime = 3600
findtime = 600
maxretry = 3
backend = systemd

[sshd]
enabled = true
port = ssh
filter = sshd
logpath = /var/log/secure
maxretry = 3
bantime = 7200
EOF

systemctl enable fail2ban
systemctl start fail2ban

echo "=== System Hardening Complete ==="
echo "Security hardening has been applied successfully."
echo "Please review the changes and test functionality."
```

#### 15.1.2 ç½‘ç»œå®‰å…¨åŠ å›º

**ç½‘ç»œæœåŠ¡å®‰å…¨é…ç½®ï¼š**

```bash
#!/bin/bash
# /opt/security/network_hardening.sh

echo "=== Network Security Hardening ==="

# 1. é…ç½®ç½‘ç»œå®‰å…¨æ‰«æ
echo "1. Configuring network security scanning..."
nmap -sS -O localhost

# 2. æ£€æŸ¥å¼€æ”¾ç«¯å£
echo "2. Checking open ports..."
netstat -tuln | grep LISTEN

# 3. é…ç½®ç½‘ç»œè®¿é—®æ§åˆ¶
echo "3. Configuring network access control..."

# ç¦ç”¨ä¸å¿…è¦çš„ç½‘ç»œåè®®
echo 0 > /proc/sys/net/ipv4/conf/all/send_redirects
echo 0 > /proc/sys/net/ipv4/conf/default/send_redirects
echo 0 > /proc/sys/net/ipv4/conf/all/accept_redirects
echo 0 > /proc/sys/net/ipv4/conf/default/accept_redirects
echo 0 > /proc/sys/net/ipv4/conf/all/accept_source_route
echo 0 > /proc/sys/net/ipv4/conf/default/accept_source_route
echo 0 > /proc/sys/net/ipv6/conf/all/accept_redirects
echo 0 > /proc/sys/net/ipv6/conf/default/accept_redirects
echo 0 > /proc/sys/net/ipv6/conf/all/accept_source_route
echo 0 > /proc/sys/net/ipv6/conf/default/accept_source_route

# 4. é…ç½®TCP/IPå®‰å…¨å‚æ•°
echo "4. Configuring TCP/IP security parameters..."
cat >> /etc/sysctl.conf << 'EOF'

# Additional Network Security Settings
net.ipv4.tcp_fin_timeout = 30
net.ipv4.tcp_keepalive_time = 1200
net.ipv4.tcp_synack_retries = 3
net.ipv4.tcp_syn_retries = 3
net.ipv4.tcp_max_syn_backlog = 1024
net.ipv4.tcp_timestamps = 0
net.ipv4.conf.all.log_martians = 1
net.ipv4.icmp_ignore_bogus_error_responses = 1
EOF

# åº”ç”¨ç½‘ç»œå‚æ•°
sysctl -p

# 5. é…ç½®ç½‘ç»œå…¥ä¾µæ£€æµ‹
echo "5. Configuring network intrusion detection..."
# å®‰è£…å’Œé…ç½®Snortï¼ˆå¯é€‰ï¼‰
# yum install snort
# é…ç½®Snortè§„åˆ™

echo "=== Network Hardening Complete ==="
```

#### 15.1.3 æœåŠ¡å®‰å…¨åŠ å›º

**å…³é”®æœåŠ¡å®‰å…¨é…ç½®ï¼š**

```bash
#!/bin/bash
# /opt/security/service_hardening.sh

echo "=== Service Security Hardening ==="

# 1. SLURMæœåŠ¡å®‰å…¨åŠ å›º
echo "1. Hardening SLURM services..."

# é…ç½®SLURMè®¤è¯
cat > /etc/slurm/auth.conf << 'EOF'
# SLURM Authentication Configuration
AuthType=auth/munge
EOF

# è®¾ç½®SLURMæ–‡ä»¶æƒé™
chmod 600 /etc/slurm/*.conf
chmod 600 /etc/slurm/auth.conf

# 2. NFSæœåŠ¡å®‰å…¨åŠ å›º
echo "2. Hardening NFS services..."
# é…ç½®NFSå®‰å…¨é€‰é¡¹
cat > /etc/exports << 'EOF'
# Secure NFS exports
/exports/data *(ro,sync,root_squash,no_all_squash)
/exports/home *(rw,sync,no_root_squash,no_all_squash)
EOF

exportfs -ra
systemctl restart nfs-server

# 3. DNSæœåŠ¡å®‰å…¨åŠ å›º
echo "3. Hardening DNS services..."
# é…ç½®BINDå®‰å…¨
cat > /etc/named.conf << 'EOF'
options {
    listen-on port 53 { 127.0.0.1; 10.0.0.0/8; };
    listen-on-v6 port 53 { ::1; };
    directory       "/var/named";
    dump-file       "/var/named/data/cache_dump.db";
    statistics-file "/var/named/data/named_stats.txt";
    memstatistics-file "/var/named/data/named_mem_stats.txt";
    allow-query     { localhost; 10.0.0.0/8; };
    recursion yes;
    dnssec-enable yes;
    dnssec-validation yes;
    bindkeys-file "/etc/named.iscdlv.key";
    managed-keys-directory "/var/named/dynamic";
    pid-file "/run/named/named.pid";
    session-keyfile "/run/named/session.key";
};

logging {
    channel default_debug {
        file "data/named.run";
        severity dynamic;
    };
};

zone "." IN {
    type hint;
    file "named.ca";
};

include "/etc/named.rfc1912.zones";
include "/etc/named.root.key";
EOF

systemctl restart named

# 4. WebæœåŠ¡å®‰å…¨åŠ å›º
echo "4. Hardening web services..."
# é…ç½®Apacheå®‰å…¨
cat > /etc/httpd/conf.d/security.conf << 'EOF'
# Apache Security Configuration

# Hide Apache version
ServerTokens Prod
ServerSignature Off

# Disable unnecessary modules
LoadModule auth_basic_module modules/mod_auth_basic.so
LoadModule auth_digest_module modules/mod_auth_digest.so
LoadModule authn_file_module modules/mod_authn_file.so
LoadModule authn_core_module modules/mod_authn_core.so
LoadModule authz_host_module modules/mod_authz_host.so
LoadModule authz_groupfile_module modules/mod_authz_groupfile.so
LoadModule authz_user_module modules/mod_authz_user.so
LoadModule authz_core_module modules/mod_authz_core.so
LoadModule access_compat_module modules/mod_access_compat.so
LoadModule authz_owner_module modules/mod_authz_owner.so

# Security headers
Header always set X-Content-Type-Options nosniff
Header always set X-Frame-Options DENY
Header always set X-XSS-Protection "1; mode=block"
Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"

# Disable TRACE
TraceEnable Off
EOF

systemctl restart httpd

echo "=== Service Hardening Complete ==="
```

### 15.2 è®¿é—®æ§åˆ¶ç­–ç•¥

#### 15.2.1 ç”¨æˆ·èº«ä»½éªŒè¯

**å¤šå› ç´ è®¤è¯é…ç½®ï¼š**

```bash
#!/bin/bash
# /opt/security/mfa_setup.sh

echo "=== Multi-Factor Authentication Setup ==="

# 1. å®‰è£…Google Authenticator PAMæ¨¡å—
echo "1. Installing Google Authenticator..."
yum install -y google-authenticator

# 2. é…ç½®PAMè¿›è¡ŒåŒå› ç´ è®¤è¯
echo "2. Configuring PAM for MFA..."
cat > /etc/pam.d/sshd.mfa << 'EOF'
# Multi-Factor Authentication for SSH
auth required pam_google_authenticator.so
auth required pam_unix.so
account required pam_unix.so
EOF

# å¤‡ä»½åŸé…ç½®
cp /etc/pam.d/sshd /etc/pam.d/sshd.backup

# æ›´æ–°SSH PAMé…ç½®
cat > /etc/pam.d/sshd << 'EOF'
# SSH with Multi-Factor Authentication
auth required pam_google_authenticator.so
auth required pam_unix.so
account required pam_unix.so
session required pam_unix.so
EOF

# 3. é…ç½®ç”¨æˆ·MFA
echo "3. Setting up MFA for users..."
for user in $(awk -F: '$3 >= 1000 && $3 < 65534 {print $1}' /etc/passwd); do
    echo "Setting up MFA for user: $user"
    # ä¸ºæ¯ä¸ªç”¨æˆ·ç”ŸæˆMFAå¯†é’¥ï¼ˆéœ€è¦ç”¨æˆ·æ‰‹åŠ¨é…ç½®ï¼‰
    echo "User $user needs to run: google-authenticator"
done

# 4. é…ç½®SSHå¯†é’¥è®¤è¯
echo "4. Configuring SSH key authentication..."
# ç”Ÿæˆä¸»æœºå¯†é’¥
ssh-keygen -t rsa -b 4096 -f /etc/ssh/ssh_host_rsa_key -N ""
ssh-keygen -t ecdsa -b 521 -f /etc/ssh/ssh_host_ecdsa_key -N ""
ssh-keygen -t ed25519 -f /etc/ssh/ssh_host_ed25519_key -N ""

systemctl restart sshd

echo "=== MFA Setup Complete ==="
echo "Users need to run 'google-authenticator' to complete setup"
```

#### 15.2.2 æƒé™ç®¡ç†

**åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰ï¼š**

```bash
#!/bin/bash
# /opt/security/rbac_setup.sh

echo "=== Role-Based Access Control Setup ==="

# 1. åˆ›å»ºç”¨æˆ·ç»„
echo "1. Creating user groups..."
groupadd hpc_admins
groupadd hpc_users
groupadd hpc_guests

# 2. åˆ›å»ºè§’è‰²ç”¨æˆ·
echo "2. Creating role users..."
useradd -g hpc_admins -G wheel -s /bin/bash hpcadmin
useradd -g hpc_users -s /bin/bash hpcuser
useradd -g hpc_guests -s /bin/bash hpcguest

# 3. é…ç½®sudoæƒé™
echo "3. Configuring sudo privileges..."
cat > /etc/sudoers.d/hpc_roles << 'EOF'
# HPC Role-Based Access Control

# HPC Administrators - Full access
%hpc_admins ALL=(ALL) ALL

# HPC Users - Limited administrative access
%hpc_users ALL=(root) /usr/bin/systemctl status *,
%hpc_users ALL=(root) /usr/bin/systemctl start *,
%hpc_users ALL=(root) /usr/bin/systemctl stop *,
%hpc_users ALL=(root) /usr/bin/systemctl restart *,
%hpc_users ALL=(root) /usr/sbin/scontrol *,
%hpc_users ALL=(root) /usr/sbin/sbatch *,
%hpc_users ALL=(root) /usr/sbin/squeue *,
%hpc_users ALL=(root) /usr/sbin/scancel *

# HPC Guests - Read-only access
%hpc_guests ALL=(root) /usr/bin/systemctl status *,
%hpc_guests ALL=(root) /usr/sbin/squeue *,
%hpc_guests ALL=(root) /bin/ls *,
%hpc_guests ALL=(root) /bin/cat *
EOF

# è®¾ç½®æ­£ç¡®çš„æƒé™
chmod 440 /etc/sudoers.d/hpc_roles

# 4. é…ç½®æ–‡ä»¶ç³»ç»Ÿæƒé™
echo "4. Configuring filesystem permissions..."
# åˆ›å»ºé¡¹ç›®ç›®å½•
mkdir -p /projects/{admin,users,guests}
chown root:hpc_admins /projects/admin
chown root:hpc_users /projects/users
chown root:hpc_guests /projects/guests

chmod 750 /projects/admin
chmod 750 /projects/users
chmod 750 /projects/guests

# è®¾ç½®ACLæƒé™
setfacl -m g:hpc_admins:rwx /projects/admin
setfacl -m g:hpc_users:rx /projects/admin
setfacl -m g:hpc_admins:rwx /projects/users
setfacl -m g:hpc_users:rwx /projects/users
setfacl -m g:hpc_guests:rx /projects/users
setfacl -m g:hpc_admins:rwx /projects/guests
setfacl -m g:hpc_users:rx /projects/guests
setfacl -m g:hpc_guests:rwx /projects/guests

# 5. é…ç½®SLURMè®¿é—®æ§åˆ¶
echo "5. Configuring SLURM access control..."
cat > /etc/slurm/slurm.conf << 'EOF'
# SLURM Configuration with Access Control

# Basic configuration
ControlMachine=slurm-master
ControlAddr=10.0.0.1
AuthType=auth/munge
CacheGroups=10
LaunchType=launch/slurm
ProctrackType=proctrack/linuxproc
ReturnToService=1
SlurmctldPidFile=/var/run/slurmctld.pid
SlurmdPidFile=/var/run/slurmd.pid
StateSaveLocation=/var/spool/slurmctld
SlurmdSpoolDir=/var/spool/slurmd
SwitchType=switch/none
MpiDefault=none
SlurmctldPort=6817
SlurmdPort=6818
TaskPlugin=task/affinity

# Access control
MaxJobCount=10000
MaxStepCount=10000
MaxTasksPerNode=128
ReturnToService=1

# Partition configuration
PartitionName=debug Nodes=ALL Default=YES MaxTime=INFINITE State=UP
PartitionName=compute Nodes=compute-[1-64] Default=NO MaxTime=72:00:00 State=UP

# User access control
AllowedUsers=hpc_user1,hpc_user2,hpc_admin1
AllowedGroups=hpc_users,hpc_admins
EOF

systemctl restart slurmctld
systemctl restart slurmd

echo "=== RBAC Setup Complete ==="
echo "Role-based access control has been configured."
```

#### 15.2.3 ç½‘ç»œè®¿é—®æ§åˆ¶

**é˜²ç«å¢™å’Œè®¿é—®æ§åˆ¶åˆ—è¡¨ï¼š**

```bash
#!/bin/bash
# /opt/security/network_acl.sh

echo "=== Network Access Control Configuration ==="

# 1. é…ç½®iptablesè§„åˆ™
echo "1. Configuring iptables rules..."

# æ¸…é™¤ç°æœ‰è§„åˆ™
iptables -F
iptables -X
iptables -t nat -F
iptables -t nat -X
iptables -t mangle -F
iptables -t mangle -X

# è®¾ç½®é»˜è®¤ç­–ç•¥
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT

# å…è®¸å›ç¯æ¥å£
iptables -A INPUT -i lo -j ACCEPT

# å…è®¸å·²å»ºç«‹çš„è¿æ¥
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# å…è®¸SSHè¿æ¥ï¼ˆé™åˆ¶é¢‘ç‡ï¼‰
iptables -A INPUT -p tcp --dport 22 -m state --state NEW -m recent --set
iptables -A INPUT -p tcp --dport 22 -m state --state NEW -m recent --update --seconds 60 --hitcount 4 -j DROP
iptables -A INPUT -p tcp --dport 22 -j ACCEPT

# å…è®¸SLURMç›¸å…³ç«¯å£
iptables -A INPUT -p tcp --dport 6817 -j ACCEPT  # slurmctld
iptables -A INPUT -p tcp --dport 6818 -j ACCEPT  # slurmdbd
iptables -A INPUT -p tcp --dport 6881:6882 -j ACCEPT  # slurmd

# å…è®¸NFSç«¯å£
iptables -A INPUT -p tcp --dport 2049 -j ACCEPT
iptables -A INPUT -p udp --dport 2049 -j ACCEPT
iptables -A INPUT -p tcp --dport 111 -j ACCEPT
iptables -A INPUT -p udp --dport 111 -j ACCEPT

# ä¿å­˜è§„åˆ™
service iptables save

# 2. é…ç½®hosts.allowå’Œhosts.deny
echo "2. Configuring TCP wrappers..."

# æ¸…ç©ºhosts.deny
echo "ALL: ALL" > /etc/hosts.deny

# é…ç½®hosts.allow
cat > /etc/hosts.allow << 'EOF'
# Allow SSH from specific networks
sshd: 10.0.0.0/255.255.0.0
sshd: 192.168.0.0/255.255.0.0

# Allow SLURM from cluster nodes
slurmctld: 10.0.0.0/255.255.0.0
slurmd: 10.0.0.0/255.255.0.0

# Allow NFS from cluster nodes
nfsd: 10.0.0.0/255.255.0.0

# Allow DNS from local network
named: 10.0.0.0/255.255.0.0
named: 192.168.0.0/255.255.0.0
EOF

# 3. é…ç½®SELinuxç­–ç•¥
echo "3. Configuring SELinux policies..."
# æ£€æŸ¥SELinuxçŠ¶æ€
sestatus

# ä¸ºHPCæœåŠ¡é…ç½®SELinuxç­–ç•¥
semanage port -a -t ssh_port_t -p tcp 22
semanage port -a -t slurm_port_t -p tcp 6817
semanage port -a -t slurm_port_t -p tcp 6818

# 4. é…ç½®ç½‘ç»œæ¥å£å®‰å…¨
echo "4. Configuring network interface security..."

# ç¦ç”¨ä¸å¿…è¦çš„ç½‘ç»œæ¥å£
for interface in $(ls /sys/class/net/ | grep -v lo); do
    # åªå¯ç”¨å¿…è¦çš„ç½‘ç»œæ¥å£
    if [[ "$interface" == eth0 ]] || [[ "$interface" == ib0 ]]; then
        echo "Keeping interface: $interface"
    else
        echo "Disabling interface: $interface"
        ifdown $interface
    fi
done

# é…ç½®ç½‘ç»œæ¥å£å‚æ•°
for interface in $(ls /sys/class/net/ | grep -v lo); do
    # ç¦ç”¨ICMPé‡å®šå‘
    echo 0 > /proc/sys/net/ipv4/conf/$interface/accept_redirects
    echo 0 > /proc/sys/net/ipv4/conf/$interface/send_redirects

    # ç¦ç”¨æºè·¯ç”±
    echo 0 > /proc/sys/net/ipv4/conf/$interface/accept_source_route
done

echo "=== Network ACL Configuration Complete ==="
```

### 15.3 å®‰å…¨å®¡è®¡ä¸ç›‘æ§

#### 15.3.1 ç³»ç»Ÿå®¡è®¡é…ç½®

**auditdå®¡è®¡ç³»ç»Ÿé…ç½®ï¼š**

```bash
#!/bin/bash
# /opt/security/audit_setup.sh

echo "=== Security Audit Configuration ==="

# 1. å®‰è£…å’Œé…ç½®auditd
echo "1. Installing and configuring auditd..."
yum install -y audit audit-libs

# é…ç½®auditè§„åˆ™
cat > /etc/audit/rules.d/hpc.rules << 'EOF'
# HPC Cluster Audit Rules

# ç›‘æ§å…³é”®ç³»ç»Ÿæ–‡ä»¶
-w /etc/passwd -p wa -k identity
-w /etc/shadow -p wa -k identity
-w /etc/group -p wa -k identity
-w /etc/gshadow -p wa -k identity

# ç›‘æ§ç”¨æˆ·ç™»å½•
-w /var/log/secure -p wa -k authentication
-w /var/log/audit/audit.log -p wa -k audit_log
-w /var/log/messages -p wa -k system_log

# ç›‘æ§å…³é”®é…ç½®æ–‡ä»¶
-w /etc/ssh/sshd_config -p wa -k ssh_config
-w /etc/sudoers -p wa -k sudo_config
-w /etc/sudoers.d/ -p wa -k sudo_config

# ç›‘æ§SLURMé…ç½®
-w /etc/slurm/ -p wa -k slurm_config
-w /var/spool/slurmctld/ -p wa -k slurm_data

# ç›‘æ§æƒé™å˜æ›´
-a always,exit -F arch=b64 -S chmod,fchmod,fchmodat -F auid>=1000 -F auid!=4294967295 -k perm_mod
-a always,exit -F arch=b32 -S chmod,fchmod,fchmodat -F auid>=1000 -F auid!=4294967295 -k perm_mod

# ç›‘æ§æ–‡ä»¶è®¿é—®
-a always,exit -F arch=b64 -S open,openat,openat2 -F exit=-EACCES -k failed_open
-a always,exit -F arch=b32 -S open,openat,openat2 -F exit=-EACCES -k failed_open

# ç›‘æ§ç‰¹æƒæ“ä½œ
-a always,exit -F arch=b64 -S execve -F euid=0 -k privileged
-a always,exit -F arch=b32 -S execve -F euid=0 -k privileged

# ç›‘æ§ç½‘ç»œè¿æ¥
-a always,exit -F arch=b64 -S socket,connect,accept,bind -k network_activity
-a always,exit -F arch=b32 -S socket,connect,accept,bind -k network_activity

# ç›‘æ§è¿›ç¨‹æ‰§è¡Œ
-a always,exit -F arch=b64 -S execve -k exec
-a always,exit -F arch=b32 -S execve -k exec
EOF

# å¯åŠ¨auditæœåŠ¡
systemctl enable auditd
systemctl start auditd

# 2. é…ç½®æ—¥å¿—è½®è½¬
echo "2. Configuring log rotation..."
cat > /etc/logrotate.d/audit << 'EOF'
/var/log/audit/audit.log {
    daily
    rotate 52
    compress
    delaycompress
    missingok
    notifempty
    postrotate
        /bin/kill -HUP `cat /var/run/auditd.pid 2> /dev/null` 2> /dev/null || true
    endscript
}
EOF

# 3. é…ç½®è¿œç¨‹æ—¥å¿—
echo "3. Configuring remote logging..."
# é…ç½®rsyslogå‘é€æ—¥å¿—åˆ°è¿œç¨‹æœåŠ¡å™¨
cat >> /etc/rsyslog.conf << 'EOF'

# Send logs to remote syslog server
*.* @@10.0.0.100:514
EOF

systemctl restart rsyslog

echo "=== Audit Configuration Complete ==="
```

#### 15.3.2 å®‰å…¨ç›‘æ§è„šæœ¬

**å®æ—¶å®‰å…¨ç›‘æ§ï¼š**

```bash
#!/bin/bash
# /opt/security/security_monitor.sh

echo "=== Real-time Security Monitoring ==="

# 1. ç›‘æ§ç”¨æˆ·ç™»å½•
echo "1. Monitoring user logins..."
last -n 20 | grep "$(date +%Y-%m-%d)"

# 2. ç›‘æ§å¯ç–‘è¿›ç¨‹
echo ""
echo "2. Monitoring suspicious processes..."
ps aux | grep -E "(nc|netcat|wget|curl)" | grep -v grep

# 3. ç›‘æ§ç½‘ç»œè¿æ¥
echo ""
echo "3. Monitoring network connections..."
netstat -tuln | grep LISTEN
ss -tuln | grep LISTEN

# 4. ç›‘æ§æ–‡ä»¶ç³»ç»Ÿå˜æ›´
echo ""
echo "4. Monitoring filesystem changes..."
inotifywait -m -r -e modify,create,delete /etc/ /var/log/ &
INOTIFY_PID=$!

# 5. ç›‘æ§ç³»ç»Ÿèµ„æºå¼‚å¸¸
echo ""
echo "5. Monitoring system resource anomalies..."
# æ£€æŸ¥CPUä½¿ç”¨ç‡å¼‚å¸¸
top -bn1 | grep "Cpu(s)" | awk '{if($8 < 10) print "High CPU usage detected: " 100-$8 "%"}'

# æ£€æŸ¥å†…å­˜ä½¿ç”¨ç‡å¼‚å¸¸
free | awk 'NR==2{if($3*100/$2 > 90) print "High memory usage detected: " $3*100/$2 "%"}'

# æ£€æŸ¥ç£ç›˜ç©ºé—´å¼‚å¸¸
df -h | awk 'NR>1{if($5+0 > 90) print "High disk usage detected: " $5 " on " $6}'

# 6. ç›‘æ§å®¡è®¡æ—¥å¿—
echo ""
echo "6. Monitoring audit logs..."
tail -f /var/log/audit/audit.log | grep -E "(failed|denied|error)" &

# 7. ç›‘æ§fail2bançŠ¶æ€
echo ""
echo "7. Monitoring fail2ban status..."
fail2ban-client status
fail2ban-client status sshd

# 8. å®šæœŸå®‰å…¨æ£€æŸ¥
echo ""
echo "8. Running periodic security checks..."

# æ£€æŸ¥å¼€æ”¾ç«¯å£
echo "Open ports:"
netstat -tuln | grep LISTEN | awk '{print $4}' | cut -d: -f2 | sort -n

# æ£€æŸ¥æœ€è¿‘çš„ç™»å½•å¤±è´¥
echo ""
echo "Recent authentication failures:"
grep "Failed password" /var/log/secure | tail -10

# æ£€æŸ¥sudoä½¿ç”¨æƒ…å†µ
echo ""
echo "Recent sudo usage:"
grep "sudo:" /var/log/secure | tail -10

# æ¸…ç†åå°è¿›ç¨‹
trap 'kill $INOTIFY_PID 2>/dev/null' EXIT

echo "=== Security Monitoring Complete ==="
echo "Monitoring processes started in background"
```

#### 15.3.3 å®‰å…¨äº‹ä»¶å“åº”

**å®‰å…¨äº‹ä»¶æ£€æµ‹å’Œå“åº”ï¼š**

```bash
#!/bin/bash
# /opt/security/incident_response.sh

echo "=== Security Incident Response System ==="

# 1. å®šä¹‰å®‰å…¨äº‹ä»¶ç±»å‹
SECURITY_EVENTS=(
    "multiple_failed_logins"
    "privilege_escalation"
    "unauthorized_file_access"
    "malware_detection"
    "network_anomaly"
    "system_compromise"
)

# 2. æ£€æµ‹å¤šç™»å½•å¤±è´¥
detect_failed_logins() {
    echo "Detecting multiple failed login attempts..."

    # æ£€æŸ¥æœ€è¿‘1å°æ—¶å†…çš„å¤±è´¥ç™»å½•
    local failed_count=$(grep "Failed password" /var/log/secure | \
        awk -v date="$(date '+%b %d %H')" '$1" "$2" "$3 ~ date' | wc -l)

    if [ $failed_count -gt 10 ]; then
        echo "ALERT: Multiple failed login attempts detected ($failed_count)"
        log_security_event "multiple_failed_logins" "High number of failed logins: $failed_count"
        block_suspicious_ips
        return 1
    fi
    return 0
}

# 3. æ£€æµ‹æƒé™æå‡
detect_privilege_escalation() {
    echo "Detecting privilege escalation attempts..."

    # æ£€æŸ¥sudoä½¿ç”¨å¼‚å¸¸
    local sudo_count=$(grep "sudo:" /var/log/secure | \
        awk -v date="$(date '+%b %d %H')" '$1" "$2" "$3 ~ date' | wc -l)

    if [ $sudo_count -gt 20 ]; then
        echo "ALERT: High number of sudo attempts detected ($sudo_count)"
        log_security_event "privilege_escalation" "High sudo activity: $sudo_count"
        return 1
    fi
    return 0
}

# 4. æ£€æµ‹æ–‡ä»¶ç³»ç»Ÿå¼‚å¸¸
detect_file_anomalies() {
    echo "Detecting filesystem anomalies..."

    # æ£€æŸ¥å…³é”®æ–‡ä»¶çš„ä¿®æ”¹
    local changed_files=$(find /etc /usr/bin /usr/sbin -type f -mtime -1 2>/dev/null | wc -l)

    if [ $changed_files -gt 5 ]; then
        echo "ALERT: Unusual number of file changes detected ($changed_files)"
        log_security_event "unauthorized_file_access" "Multiple file changes: $changed_files"
        return 1
    fi
    return 0
}

# 5. æ£€æµ‹æ¶æ„è½¯ä»¶
detect_malware() {
    echo "Running malware detection..."

    # ä½¿ç”¨rkhunteræ£€æŸ¥
    if command -v rkhunter &> /dev/null; then
        rkhunter --check --skip-keypress --report-warnings-only > /tmp/rkhunter.log
        local warnings=$(grep -c "Warning" /tmp/rkhunter.log)

        if [ $warnings -gt 0 ]; then
            echo "ALERT: Rootkit hunter detected $warnings warnings"
            log_security_event "malware_detection" "Rootkit hunter warnings: $warnings"
            return 1
        fi
    fi
    return 0
}

# 6. æ£€æµ‹ç½‘ç»œå¼‚å¸¸
detect_network_anomalies() {
    echo "Detecting network anomalies..."

    # æ£€æŸ¥å¼‚å¸¸ç½‘ç»œè¿æ¥
    local connections=$(netstat -an | grep ESTABLISHED | wc -l)
    local listening_ports=$(netstat -tuln | grep LISTEN | wc -l)

    # æ£€æŸ¥æ˜¯å¦æœ‰æœªçŸ¥ç«¯å£
    local unknown_ports=$(netstat -tuln | grep LISTEN | \
        awk '{print $4}' | cut -d: -f2 | \
        grep -v -E "22|53|80|443|6817|6818|2049|111" | wc -l)

    if [ $unknown_ports -gt 0 ]; then
        echo "ALERT: Unknown listening ports detected ($unknown_ports)"
        log_security_event "network_anomaly" "Unknown ports: $unknown_ports"
        return 1
    fi
    return 0
}

# 7. è®°å½•å®‰å…¨äº‹ä»¶
log_security_event() {
    local event_type=$1
    local description=$2
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')

    echo "$timestamp,$event_type,$description" >> /var/log/security_events.log

    # å‘é€å‘Šè­¦
    send_security_alert "$event_type" "$description"
}

# 8. å‘é€å®‰å…¨å‘Šè­¦
send_security_alert() {
    local event_type=$1
    local description=$2

    # é‚®ä»¶å‘Šè­¦
    echo "Security Alert: $event_type - $description" | \
        mail -s "Security Alert: $event_type" admin@hpc.example.com

    # ç³»ç»Ÿæ—¥å¿—
    logger -p local0.err "Security Alert: $event_type - $description"
}

# 9. é˜»æ­¢å¯ç–‘IP
block_suspicious_ips() {
    echo "Blocking suspicious IP addresses..."

    # ä»æ—¥å¿—ä¸­æå–å¯ç–‘IP
    grep "Failed password" /var/log/secure | \
        awk '{print $(NF-3)}' | \
        sort | uniq -c | sort -nr | head -5 | \
        while read count ip; do
            if [ $count -gt 5 ]; then
                echo "Blocking IP: $ip (failed attempts: $count)"
                iptables -A INPUT -s $ip -j DROP
            fi
        done
}

# 10. ä¸»æ£€æµ‹å¾ªç¯
main() {
    echo "Starting security monitoring..."

    while true; do
        detect_failed_logins
        detect_privilege_escalation
        detect_file_anomalies
        detect_malware
        detect_network_anomalies

        # ç­‰å¾…5åˆ†é’Ÿ
        sleep 300
    done
}

# è¿è¡Œä¸»å‡½æ•°
main
```

### 15.4 æ¼æ´ç®¡ç†

#### 15.4.1 æ¼æ´æ‰«æ

**è‡ªåŠ¨åŒ–æ¼æ´æ‰«æè„šæœ¬ï¼š**

```bash
#!/bin/bash
# /opt/security/vulnerability_scan.sh

echo "=== Vulnerability Scanning System ==="

# 1. ç³»ç»Ÿè¡¥ä¸æ£€æŸ¥
check_system_patches() {
    echo "1. Checking system patches..."
    yum check-update --security
}

# 2. å·²çŸ¥æ¼æ´æ£€æŸ¥
check_known_vulnerabilities() {
    echo "2. Checking for known vulnerabilities..."

    # æ£€æŸ¥CVEæ¼æ´
    if command -v yum-utils &> /dev/null; then
        yum install -y yum-utils
        yum updateinfo list installed | grep CVE
    fi

    # æ£€æŸ¥å…³é”®è½¯ä»¶ç‰ˆæœ¬
    check_software_versions
}

# 3. è½¯ä»¶ç‰ˆæœ¬æ£€æŸ¥
check_software_versions() {
    echo "3. Checking software versions..."

    # æ£€æŸ¥å…³é”®è½¯ä»¶
    local packages=(
        "openssh-server"
        "openssl"
        "kernel"
        "httpd"
        "bind"
        "slurm"
    )

    for package in "${packages[@]}"; do
        if rpm -q $package &> /dev/null; then
            local version=$(rpm -q $package)
            echo "Package: $version"
        fi
    done
}

# 4. é…ç½®æ¼æ´æ£€æŸ¥
check_configuration_vulnerabilities() {
    echo "4. Checking configuration vulnerabilities..."

    # æ£€æŸ¥SSHé…ç½®
    if grep -q "PermitRootLogin yes" /etc/ssh/sshd_config; then
        echo "WARNING: Root login is enabled in SSH"
    fi

    if grep -q "PasswordAuthentication yes" /etc/ssh/sshd_config; then
        echo "WARNING: Password authentication is enabled in SSH"
    fi

    # æ£€æŸ¥æ–‡ä»¶æƒé™
    check_file_permissions
}

# 5. æ–‡ä»¶æƒé™æ£€æŸ¥
check_file_permissions() {
    echo "5. Checking file permissions..."

    # æ£€æŸ¥å…³é”®æ–‡ä»¶æƒé™
    local files=(
        "/etc/passwd"
        "/etc/shadow"
        "/etc/group"
        "/etc/ssh/sshd_config"
        "/etc/sudoers"
    )

    for file in "${files[@]}"; do
        if [ -f "$file" ]; then
            local perms=$(stat -c "%a" $file)
            echo "File: $file, Permissions: $perms"
        fi
    done
}

# 6. ç½‘ç»œæœåŠ¡æ¼æ´æ£€æŸ¥
check_network_services() {
    echo "6. Checking network services..."

    # æ‰«æå¼€æ”¾ç«¯å£
    nmap -sS localhost

    # æ£€æŸ¥æœåŠ¡ç‰ˆæœ¬
    for port in 22 80 443 53 6817 6818; do
        if netstat -tuln | grep -q ":$port "; then
            echo "Service running on port $port"
        fi
    done
}

# 7. æ¼æ´æŠ¥å‘Šç”Ÿæˆ
generate_vulnerability_report() {
    echo "7. Generating vulnerability report..."

    local report_file="/tmp/vulnerability_report_$(date +%Y%m%d_%H%M%S).txt"

    cat > $report_file << 'EOF'
HPC Cluster Vulnerability Assessment Report
===========================================

Generated: $(date)
Hostname: $(hostname)

Vulnerability Summary:
EOF

    # æ·»åŠ æ£€æŸ¥ç»“æœ
    echo "" >> $report_file
    echo "System Patches:" >> $report_file
    yum check-update --security >> $report_file 2>&1

    echo "" >> $report_file
    echo "Software Versions:" >> $report_file
    check_software_versions >> $report_file

    echo "" >> $report_file
    echo "Configuration Issues:" >> $report_file
    check_configuration_vulnerabilities >> $report_file

    echo "" >> $report_file
    echo "Network Services:" >> $report_file
    check_network_services >> $report_file

    echo "Report generated: $report_file"
    return 0
}

# 8. ä¸»å‡½æ•°
main() {
    echo "Starting vulnerability assessment..."

    check_system_patches
    check_known_vulnerabilities
    check_configuration_vulnerabilities
    check_network_services
    generate_vulnerability_report

    echo "Vulnerability assessment complete."
}

# è¿è¡Œä¸»å‡½æ•°
main
```

#### 15.4.2 è¡¥ä¸ç®¡ç†

**è‡ªåŠ¨åŒ–è¡¥ä¸ç®¡ç†ç³»ç»Ÿï¼š**

```bash
#!/bin/bash
# /opt/security/patch_management.sh

echo "=== Automated Patch Management System ==="

# 1. è¡¥ä¸ç­–ç•¥é…ç½®
PATCH_POLICY="security_only"  # security_only, critical, all
AUTO_REBOOT=false
MAINTENANCE_WINDOW="02:00-04:00"

# 2. æ£€æŸ¥å¯ç”¨è¡¥ä¸
check_available_patches() {
    echo "1. Checking available patches..."

    case $PATCH_POLICY in
        "security_only")
            echo "Checking security updates only..."
            yum check-update --security
            ;;
        "critical")
            echo "Checking critical updates..."
            yum check-update --advisory=critical
            ;;
        "all")
            echo "Checking all updates..."
            yum check-update
            ;;
    esac
}

# 3. ä¸‹è½½è¡¥ä¸
download_patches() {
    echo "2. Downloading patches..."

    case $PATCH_POLICY in
        "security_only")
            yum update --security -y
            ;;
        "critical")
            yum update --advisory=critical -y
            ;;
        "all")
            yum update -y
            ;;
    esac
}

# 4. åº”ç”¨è¡¥ä¸
apply_patches() {
    echo "3. Applying patches..."

    # åˆ›å»ºå¤‡ä»½
    create_system_backup

    # åº”ç”¨è¡¥ä¸
    download_patches

    # éªŒè¯è¡¥ä¸åº”ç”¨
    verify_patch_application

    # è®°å½•è¡¥ä¸åº”ç”¨
    log_patch_application
}

# 5. åˆ›å»ºç³»ç»Ÿå¤‡ä»½
create_system_backup() {
    echo "4. Creating system backup..."

    local backup_dir="/backup/patch_backup_$(date +%Y%m%d_%H%M%S)"
    mkdir -p $backup_dir

    # å¤‡ä»½å…³é”®é…ç½®æ–‡ä»¶
    cp -r /etc $backup_dir/
    cp -r /var/spool/slurmctld $backup_dir/
    cp -r /var/log $backup_dir/

    # åˆ›å»ºRPMåŒ…åˆ—è¡¨
    rpm -qa > $backup_dir/installed_packages.txt

    echo "Backup created: $backup_dir"
}

# 6. éªŒè¯è¡¥ä¸åº”ç”¨
verify_patch_application() {
    echo "5. Verifying patch application..."

    # æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
    systemctl status sshd
    systemctl status slurmctld
    systemctl status slurmdbd

    # æ£€æŸ¥å…³é”®æœåŠ¡
    for service in sshd slurmctld slurmdbd httpd named; do
        if systemctl is-active --quiet $service; then
            echo "âœ“ $service: Running"
        else
            echo "âœ— $service: Failed"
        fi
    done

    # æ£€æŸ¥ç½‘ç»œè¿æ¥
    ping -c 3 8.8.8.8 > /dev/null
    if [ $? -eq 0 ]; then
        echo "âœ“ Network connectivity: OK"
    else
        echo "âœ— Network connectivity: Failed"
    fi
}

# 7. è®°å½•è¡¥ä¸åº”ç”¨
log_patch_application() {
    echo "6. Logging patch application..."

    local log_file="/var/log/patch_management.log"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')

    echo "$timestamp - Patch application completed" >> $log_file
    echo "$timestamp - Patch policy: $PATCH_POLICY" >> $log_file
    echo "$timestamp - Auto reboot: $AUTO_REBOOT" >> $log_file

    # è®°å½•åº”ç”¨çš„è¡¥ä¸
    yum history list | tail -5 >> $log_file
}

# 8. è‡ªåŠ¨é‡å¯ç®¡ç†
manage_reboot() {
    if [ "$AUTO_REBOOT" = true ]; then
        echo "7. Scheduling automatic reboot..."

        # æ£€æŸ¥æ˜¯å¦éœ€è¦é‡å¯
        if [ -f /var/run/reboot-required ]; then
            echo "Reboot required. Scheduling reboot during maintenance window..."

            # åœ¨ç»´æŠ¤çª—å£å†…é‡å¯
            echo "shutdown -r +5" | at $MAINTENANCE_WINDOW
        fi
    fi
}

# 9. è¡¥ä¸å›æ»š
rollback_patches() {
    echo "8. Rolling back patches..."

    local backup_dir=$(ls -t /backup/patch_backup_* 2>/dev/null | head -1)

    if [ -z "$backup_dir" ]; then
        echo "No backup found for rollback"
        return 1
    fi

    echo "Rolling back from: $backup_dir"

    # æ¢å¤é…ç½®æ–‡ä»¶
    cp -r $backup_dir/etc/* /etc/
    cp -r $backup_dir/var/spool/slurmctld/* /var/spool/slurmctld/

    # é‡æ–°å®‰è£…åŸå§‹åŒ…
    yum history undo last -y

    # é‡å¯ç³»ç»Ÿ
    reboot
}

# 10. ä¸»å‡½æ•°
main() {
    echo "Starting patch management process..."

    # æ£€æŸ¥ç»´æŠ¤çª—å£
    current_hour=$(date +%H)
    if [ $current_hour -lt 2 ] || [ $current_hour -gt 4 ]; then
        echo "Outside maintenance window. Continuing with patch check only."
    fi

    check_available_patches
    apply_patches
    manage_reboot

    echo "Patch management process complete."
}

# è¿è¡Œä¸»å‡½æ•°
main
```

#### 15.4.3 æ¼æ´ä¿®å¤è„šæœ¬

**è‡ªåŠ¨åŒ–æ¼æ´ä¿®å¤ï¼š**

```bash
#!/bin/bash
# /opt/security/automated_fixes.sh

echo "=== Automated Vulnerability Fixes ==="

# 1. ä¿®å¤SSHé…ç½®æ¼æ´
fix_ssh_config() {
    echo "1. Fixing SSH configuration vulnerabilities..."

    # ç¦ç”¨rootç™»å½•
    sed -i 's/^PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config
    sed -i 's/^PermitRootLogin prohibit-password/PermitRootLogin no/' /etc/ssh/sshd_config

    # ç¦ç”¨ç©ºå¯†ç 
    sed -i 's/^PermitEmptyPasswords yes/PermitEmptyPasswords no/' /etc/ssh/sshd_config

    # è®¾ç½®æœ€å¤§è®¤è¯å°è¯•æ¬¡æ•°
    if ! grep -q "MaxAuthTries" /etc/ssh/sshd_config; then
        echo "MaxAuthTries 3" >> /etc/ssh/sshd_config
    fi

    # é‡å¯SSHæœåŠ¡
    systemctl restart sshd
}

# 2. ä¿®å¤æ–‡ä»¶æƒé™é—®é¢˜
fix_file_permissions() {
    echo "2. Fixing file permissions..."

    # ä¿®å¤å…³é”®æ–‡ä»¶æƒé™
    chmod 600 /etc/shadow
    chmod 644 /etc/passwd
    chmod 644 /etc/group
    chmod 600 /etc/gshadow

    # ä¿®å¤SSHé…ç½®æ–‡ä»¶æƒé™
    chmod 600 /etc/ssh/sshd_config
    chmod 644 /etc/ssh/ssh_host_key.pub

    # ä¿®å¤sudoersæ–‡ä»¶æƒé™
    chmod 440 /etc/sudoers
    chmod 440 /etc/sudoers.d/*
}

# 3. ä¿®å¤ç½‘ç»œæœåŠ¡é…ç½®
fix_network_services() {
    echo "3. Fixing network service configurations..."

    # ä¿®å¤NFSé…ç½®
    if [ -f /etc/exports ]; then
        sed -i 's/rw,/rw,no_root_squash,/' /etc/exports
        exportfs -ra
    fi

    # ä¿®å¤DNSé…ç½®
    if [ -f /etc/named.conf ]; then
        # é™åˆ¶DNSæŸ¥è¯¢èŒƒå›´
        sed -i 's/allow-query.*{.*};/allow-query     { localhost; 10.0.0.0\/8; };/' /etc/named.conf
        systemctl restart named
    fi
}

# 4. ä¿®å¤ç³»ç»ŸæœåŠ¡é…ç½®
fix_system_services() {
    echo "4. Fixing system service configurations..."

    # ç¦ç”¨ä¸å¿…è¦çš„æœåŠ¡
    local services_to_disable=(
        "telnet"
        "rsh"
        "rlogin"
        "ftp"
        "tftp"
        "finger"
    )

    for service in "${services_to_disable[@]}"; do
        if systemctl list-unit-files | grep -q "^$service"; then
            systemctl stop $service 2>/dev/null
            systemctl disable $service 2>/dev/null
        fi
    done

    # å¯ç”¨å®‰å…¨æœåŠ¡
    systemctl enable fail2ban
    systemctl start fail2ban
    systemctl enable firewalld
    systemctl start firewalld
}

# 5. ä¿®å¤å†…æ ¸å‚æ•°
fix_kernel_parameters() {
    echo "5. Fixing kernel security parameters..."

    cat > /etc/sysctl.d/99-security-fixes.conf << 'EOF'
# Security Parameter Fixes

# Disable IP forwarding
net.ipv4.ip_forward = 0

# Disable ICMP redirects
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv6.conf.all.accept_redirects = 0
net.ipv6.conf.default.accept_redirects = 0

# Disable source route packets
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0
net.ipv6.conf.all.accept_source_route = 0
net.ipv6.conf.default.accept_source_route = 0

# Enable TCP SYN Cookie Protection
net.ipv4.tcp_syncookies = 1

# Disable broadcast ICMP
net.ipv4.icmp_echo_ignore_broadcasts = 1

# Log martian packets
net.ipv4.conf.all.log_martians = 1
net.ipv4.conf.default.log_martians = 1

# Enable IP spoofing protection
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.default.rp_filter = 1
EOF

    sysctl -p /etc/sysctl.d/99-security-fixes.conf
}

# 6. ä¿®å¤ç”¨æˆ·è´¦æˆ·é—®é¢˜
fix_user_accounts() {
    echo "6. Fixing user account issues..."

    # é”å®šç©ºå¯†ç è´¦æˆ·
    for user in $(awk -F: '($2 == "" ) { print $1 }' /etc/shadow); do
        if [ "$user" != "root" ]; then
            passwd -l $user
            echo "Locked user: $user"
        fi
    done

    # è®¾ç½®å¯†ç ç­–ç•¥
    if [ -f /etc/login.defs ]; then
        sed -i 's/^PASS_MAX_DAYS.*/PASS_MAX_DAYS   90/' /etc/login.defs
        sed -i 's/^PASS_MIN_DAYS.*/PASS_MIN_DAYS   1/' /etc/login.defs
        sed -i 's/^PASS_WARN_AGE.*/PASS_WARN_AGE   7/' /etc/login.defs
    fi

    # è®¾ç½®å¯†ç å¤æ‚åº¦
    if [ -f /etc/pam.d/system-auth ]; then
        echo "password requisite pam_pwquality.so try_first_pass local_users_only retry=3 authtok_type=" >> /etc/pam.d/system-auth
    fi
}

# 7. ä¿®å¤é˜²ç«å¢™è§„åˆ™
fix_firewall_rules() {
    echo "7. Fixing firewall rules..."

    # æ¸…é™¤ç°æœ‰è§„åˆ™
    iptables -F
    iptables -X

    # è®¾ç½®é»˜è®¤ç­–ç•¥
    iptables -P INPUT DROP
    iptables -P FORWARD DROP
    iptables -P OUTPUT ACCEPT

    # å…è®¸å›ç¯æ¥å£
    iptables -A INPUT -i lo -j ACCEPT

    # å…è®¸å·²å»ºç«‹çš„è¿æ¥
    iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

    # å…è®¸SSHè¿æ¥
    iptables -A INPUT -p tcp --dport 22 -m state --state NEW -m recent --set
    iptables -A INPUT -p tcp --dport 22 -m state --state NEW -m recent --update --seconds 60 --hitcount 4 -j DROP
    iptables -A INPUT -p tcp --dport 22 -j ACCEPT

    # ä¿å­˜è§„åˆ™
    service iptables save
}

# 8. ä¸»å‡½æ•°
main() {
    echo "Starting automated vulnerability fixes..."

    fix_ssh_config
    fix_file_permissions
    fix_network_services
    fix_system_services
    fix_kernel_parameters
    fix_user_accounts
    fix_firewall_rules

    echo "Automated vulnerability fixes complete."
    echo "Please restart the system to apply all changes."
}

# è¿è¡Œä¸»å‡½æ•°
main
```

## ğŸ› ï¸ å®‰å…¨ç®¡ç†å·¥å…·é›†

### 15.5 å®‰å…¨æ£€æŸ¥å·¥å…·

**ç»¼åˆå®‰å…¨æ£€æŸ¥è„šæœ¬ï¼š**

```bash
#!/bin/bash
# /opt/security/comprehensive_security_check.sh

echo "=== Comprehensive Security Check ==="

# 1. ç³»ç»Ÿä¿¡æ¯æ”¶é›†
collect_system_info() {
    echo "1. Collecting system information..."
    echo "Hostname: $(hostname)"
    echo "OS Version: $(cat /etc/os-release | grep PRETTY_NAME)"
    echo "Kernel Version: $(uname -r)"
    echo "Uptime: $(uptime)"
}

# 2. ç”¨æˆ·å’Œç»„æ£€æŸ¥
check_users_and_groups() {
    echo ""
    echo "2. Checking users and groups..."

    # æ£€æŸ¥ç©ºå¯†ç ç”¨æˆ·
    echo "Users with empty passwords:"
    awk -F: '($2 == "" ) { print $1 }' /etc/shadow

    # æ£€æŸ¥UID 0ç”¨æˆ·
    echo ""
    echo "Users with UID 0:"
    awk -F: '($3 == 0) { print $1 }' /etc/passwd

    # æ£€æŸ¥æœ€è¿‘ç™»å½•çš„ç”¨æˆ·
    echo ""
    echo "Recent logins:"
    last -n 10
}

# 3. ç½‘ç»œé…ç½®æ£€æŸ¥
check_network_configuration() {
    echo ""
    echo "3. Checking network configuration..."

    # æ£€æŸ¥å¼€æ”¾ç«¯å£
    echo "Open ports:"
    netstat -tuln | grep LISTEN

    # æ£€æŸ¥ç½‘ç»œæ¥å£
    echo ""
    echo "Network interfaces:"
    ip addr show

    # æ£€æŸ¥è·¯ç”±è¡¨
    echo ""
    echo "Routing table:"
    ip route show
}

# 4. æœåŠ¡æ£€æŸ¥
check_services() {
    echo ""
    echo "4. Checking services..."

    # æ£€æŸ¥è¿è¡Œçš„æœåŠ¡
    echo "Running services:"
    systemctl list-units --type=service --state=running | head -20

    # æ£€æŸ¥å¯åŠ¨é¡¹
    echo ""
    echo "Services enabled at boot:"
    systemctl list-unit-files --type=service | grep enabled | head -10
}

# 5. æ–‡ä»¶ç³»ç»Ÿæ£€æŸ¥
check_filesystem() {
    echo ""
    echo "5. Checking filesystem..."

    # æ£€æŸ¥æŒ‚è½½ç‚¹
    echo "Mounted filesystems:"
    mount | grep -E "^/dev"

    # æ£€æŸ¥ç£ç›˜ä½¿ç”¨ç‡
    echo ""
    echo "Disk usage:"
    df -h

    # æ£€æŸ¥å…³é”®æ–‡ä»¶æƒé™
    echo ""
    echo "Critical file permissions:"
    ls -la /etc/passwd /etc/shadow /etc/group /etc/ssh/sshd_config
}

# 6. å®‰å…¨é…ç½®æ£€æŸ¥
check_security_configuration() {
    echo ""
    echo "6. Checking security configuration..."

    # æ£€æŸ¥SSHé…ç½®
    echo "SSH Configuration:"
    grep -E "PermitRootLogin|PasswordAuthentication|MaxAuthTries" /etc/ssh/sshd_config

    # æ£€æŸ¥sudoé…ç½®
    echo ""
    echo "Sudo Configuration:"
    ls -la /etc/sudoers /etc/sudoers.d/

    # æ£€æŸ¥é˜²ç«å¢™çŠ¶æ€
    echo ""
    echo "Firewall Status:"
    firewall-cmd --state 2>/dev/null || echo "Firewall not running"

    # æ£€æŸ¥SELinuxçŠ¶æ€
    echo ""
    echo "SELinux Status:"
    sestatus
}

# 7. æ—¥å¿—æ£€æŸ¥
check_logs() {
    echo ""
    echo "7. Checking logs..."

    # æ£€æŸ¥è®¤è¯æ—¥å¿—
    echo "Recent authentication failures:"
    grep "Failed password" /var/log/secure | tail -5

    # æ£€æŸ¥sudoæ—¥å¿—
    echo ""
    echo "Recent sudo usage:"
    grep "sudo:" /var/log/secure | tail -5

    # æ£€æŸ¥ç³»ç»Ÿæ—¥å¿—é”™è¯¯
    echo ""
    echo "Recent system errors:"
    grep -i error /var/log/messages | tail -5
}

# 8. è¡¥ä¸çŠ¶æ€æ£€æŸ¥
check_patches() {
    echo ""
    echo "8. Checking patch status..."

    # æ£€æŸ¥å®‰å…¨æ›´æ–°
    echo "Available security updates:"
    yum check-update --security 2>/dev/null | grep -E "^[a-z]" | wc -l

    # æ£€æŸ¥å…³é”®è½¯ä»¶ç‰ˆæœ¬
    echo ""
    echo "Critical software versions:"
    rpm -q openssh-server openssl kernel
}

# 9. ç”Ÿæˆå®‰å…¨æŠ¥å‘Š
generate_security_report() {
    echo ""
    echo "9. Generating security report..."

    local report_file="/tmp/security_assessment_$(date +%Y%m%d_%H%M%S).txt"

    echo "HPC Cluster Security Assessment Report" > $report_file
    echo "Generated: $(date)" >> $report_file
    echo "Hostname: $(hostname)" >> $report_file
    echo "" >> $report_file

    # æ·»åŠ æ£€æŸ¥ç»“æœ
    echo "=== System Information ===" >> $report_file
    collect_system_info >> $report_file
    echo "" >> $report_file

    echo "=== Security Issues Found ===" >> $report_file
    echo "Users with empty passwords:" >> $report_file
    awk -F: '($2 == "" ) { print $1 }' /etc/shadow >> $report_file
    echo "" >> $report_file

    echo "Open ports:" >> $report_file
    netstat -tuln | grep LISTEN >> $report_file
    echo "" >> $report_file

    echo "Available security updates:" >> $report_file
    yum check-update --security 2>/dev/null | grep -E "^[a-z]" | wc -l >> $report_file

    echo "Security report saved to: $report_file"
}

# 10. ä¸»å‡½æ•°
main() {
    echo "Starting comprehensive security check..."

    collect_system_info
    check_users_and_groups
    check_network_configuration
    check_services
    check_filesystem
    check_security_configuration
    check_logs
    check_patches
    generate_security_report

    echo ""
    echo "=== Security Check Complete ==="
    echo "Review the generated report for detailed findings."
}

# è¿è¡Œä¸»å‡½æ•°
main
```

## ğŸ“š æœ€ä½³å®è·µ

### 15.6 å®‰å…¨ç®¡ç†åŸåˆ™

#### 15.6.1 å®‰å…¨åŠ å›ºåŸåˆ™

1. **æœ€å°æƒé™åŸåˆ™**ï¼šåªæˆäºˆå¿…è¦çš„æœ€å°æƒé™
2. **çºµæ·±é˜²å¾¡**ï¼šå¤šå±‚å®‰å…¨é˜²æŠ¤æœºåˆ¶
3. **é»˜è®¤æ‹’ç»**ï¼šé»˜è®¤æ‹’ç»æ‰€æœ‰æœªæ˜ç¡®å…è®¸çš„è®¿é—®
4. **å®šæœŸå®¡è®¡**ï¼šå®šæœŸæ£€æŸ¥å’ŒéªŒè¯å®‰å…¨é…ç½®
5. **åŠæ—¶æ›´æ–°**ï¼šåŠæ—¶åº”ç”¨å®‰å…¨è¡¥ä¸å’Œæ›´æ–°

#### 15.6.2 å®‰å…¨ç›‘æ§åŸåˆ™

1. **å®æ—¶ç›‘æ§**ï¼šæŒç»­ç›‘æ§å…³é”®å®‰å…¨æŒ‡æ ‡
2. **æ—¥å¿—åˆ†æ**ï¼šå®šæœŸåˆ†æå®‰å…¨æ—¥å¿—
3. **å¼‚å¸¸æ£€æµ‹**ï¼šå»ºç«‹å¼‚å¸¸è¡Œä¸ºæ£€æµ‹æœºåˆ¶
4. **å‘Šè­¦å“åº”**ï¼šå»ºç«‹å¿«é€Ÿå“åº”æœºåˆ¶
5. **äº‹ä»¶è®°å½•**ï¼šè¯¦ç»†è®°å½•å®‰å…¨äº‹ä»¶

#### 15.6.3 æ¼æ´ç®¡ç†åŸåˆ™

1. **å®šæœŸæ‰«æ**ï¼šå®šæœŸè¿›è¡Œæ¼æ´æ‰«æ
2. **é£é™©è¯„ä¼°**ï¼šè¯„ä¼°æ¼æ´çš„ä¸¥é‡æ€§å’Œå½±å“
3. **ä¼˜å…ˆä¿®å¤**ï¼šä¼˜å…ˆä¿®å¤é«˜é£é™©æ¼æ´
4. **éªŒè¯æµ‹è¯•**ï¼šéªŒè¯ä¿®å¤æ•ˆæœ
5. **æŒç»­ç›‘æ§**ï¼šæŒç»­ç›‘æ§æ–°å‡ºç°çš„æ¼æ´

## ğŸ“ æœ¬ç« æ€»ç»“

å®‰å…¨ç®¡ç†æ˜¯HPCè¿ç»´çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œé€šè¿‡æœ¬ç« å­¦ä¹ ï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

- âœ… å®æ–½ç³»ç»Ÿå®‰å…¨åŠ å›ºï¼ˆæ“ä½œç³»ç»Ÿã€ç½‘ç»œã€æœåŠ¡ï¼‰
- âœ… é…ç½®æœ‰æ•ˆçš„è®¿é—®æ§åˆ¶ç­–ç•¥ï¼ˆèº«ä»½éªŒè¯ã€æƒé™ç®¡ç†ï¼‰
- âœ… å»ºç«‹å®Œå–„çš„å®‰å…¨å®¡è®¡å’Œç›‘æ§ä½“ç³»
- âœ… å®æ–½ç³»ç»Ÿçš„æ¼æ´ç®¡ç†æµç¨‹
- âœ… å¤„ç†å®‰å…¨äº‹ä»¶å’Œåº”æ€¥å“åº”

å®‰å…¨æ˜¯ä¸€ä¸ªæŒç»­çš„è¿‡ç¨‹ï¼Œéœ€è¦ç»“åˆæŠ€æœ¯æ‰‹æ®µã€ç®¡ç†æµç¨‹å’Œäººå‘˜åŸ¹è®­ï¼Œå»ºç«‹å…¨æ–¹ä½çš„å®‰å…¨é˜²æŠ¤ä½“ç³»ã€‚

## ğŸ“ ç»ƒä¹ é¢˜

1. **å®è·µé¢˜**ï¼šä¸ºä½ çš„é›†ç¾¤å®æ–½å®Œæ•´çš„ç³»ç»Ÿå®‰å…¨åŠ å›º
2. **é…ç½®é¢˜**ï¼šé…ç½®åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶å’Œå¤šå› ç´ è®¤è¯
3. **ç›‘æ§é¢˜**ï¼šéƒ¨ç½²å®‰å…¨ç›‘æ§å’Œå®¡è®¡ç³»ç»Ÿ
4. **åº”æ€¥é¢˜**ï¼šæ¨¡æ‹Ÿå®‰å…¨äº‹ä»¶å¹¶ç»ƒä¹ åº”æ€¥å“åº”æµç¨‹

## ğŸ”— å‚è€ƒèµ„æº

- [CIS Benchmarks](https://www.cisecurity.org/cis-benchmarks/)
- [NIST Cybersecurity Framework](https://www.nist.gov/cyberframework)
- [Linux Security Documentation](https://linux.die.net/man/5/auditd.conf)
- [HPC Security Best Practices](https://www.hpcadvisorycouncil.com/pdf/HPC_security.pdf)